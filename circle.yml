machine:
  environment:
    PATH: $PATH:$HOME/terraform:$HOME/packer:$HOME/glide/linux-amd64

dependencies:
  override:
    # Install the gruntwork-module-circleci-helpers and use it to configure the build environment and run tests.
    - curl -Ls https://raw.githubusercontent.com/gruntwork-io/gruntwork-installer/master/bootstrap-gruntwork-installer.sh | bash /dev/stdin --version v0.0.14
    - gruntwork-install --module-name "gruntwork-module-circleci-helpers" --repo "https://github.com/gruntwork-io/module-ci" --tag "v0.3.11"
    - gruntwork-install --module-name "build-helpers" --repo "https://github.com/gruntwork-io/module-ci" --tag "v0.3.11"
    - gruntwork-install --module-name "aws-helpers" --repo "https://github.com/gruntwork-io/module-ci" --tag "v0.3.11"
    - configure-environment-for-gruntwork-module --go-src-path test

  cache_directories:
    - ~/terraform
    - ~/packer
    - ~/glide

test:
  override:
    - run-go-tests --path test

deployment:
  release:
    tag: /v.*/
    commands:
      # If a new release is tagged in GitHub, build the AMI and publish it to all regions.
      # - We take the somewhat awkward step of running the following commands in the background so that both Packer builds
      #   can run simultaneously. The alternative would be to rewrite packer-build-artifact to support multiple builds,
      #   but this simple hack seems more efficient.
      # - Note that build output is available in ~/ubuntu16/packer-build.log and ~/amazon-linux/packer-build.log
      - mkdir -p ~/ubuntu16 && cd ~/ubuntu16 && ~/$CIRCLE_PROJECT_REPONAME/_ci/publish-amis.sh "ubuntu-16-ami" &
      - mkdir -p ~/amazon-linux && cd ~/amazon-linux && ~/$CIRCLE_PROJECT_REPONAME/_ci/publish-amis.sh "amazon-linux-ami" &

  tmp-test:
    branch: publish-amis
    commands:
      # If a new release is tagged in GitHub, build the AMI and publish it to all regions.
      # - We take the somewhat awkward step of running the following commands in the background so that both Packer builds
      #   can run simultaneously. The alternative would be to rewrite packer-build-artifact to support multiple builds,
      #   but this simple hack seems more efficient.
      # - Note that build output is available in ~/ubuntu16/packer-build.log and ~/amazon-linux/packer-build.log
      - mkdir -p ~/ubuntu16 && cd ~/ubuntu16 && ~/$CIRCLE_PROJECT_REPONAME/_ci/publish-amis.sh "ubuntu-16-ami" &
      - mkdir -p ~/amazon-linux && cd ~/amazon-linux && ~/$CIRCLE_PROJECT_REPONAME/_ci/publish-amis.sh "amazon-linux-ami" &